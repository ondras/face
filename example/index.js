var l=class{#t=new Map;#e=0;createEntity(t={}){let e=++this.#e;return t&&this.#t.set(e,structuredClone(t)),e}addComponent(t,e,r){let n=this.#t.get(t);n||(n={},this.#t.set(t,n)),n[e]=r}removeComponent(t,...e){let r=this.#t.get(t);e.forEach(n=>delete r[n])}hasComponents(t,...e){let r=this.#t.get(t);return r?y(r,e):!1}findEntities(...t){let e=[];for(let[r,n]of this.#t.entries())y(n,t)&&e.push({entity:r,...n});return e}getComponent(t,e){let r=this.#t.get(t);return r&&r[e]}getComponents(t,...e){return this.#t.get(t)}requireComponent(t,e){let r=this.getComponent(t,e);if(!r)throw new Error;return r}requireComponents(t,...e){let r=this.getComponents(t,...e);if(!r||!y(r,e))throw new Error;return r}};function y(o,t){return t.every(e=>e in o)}var c=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let e=t.find(({actor:r})=>r.wait==0);return e?(e.actor.wait=1,e.entity):(t.forEach(({actor:r})=>r.wait=0),this.next())}},d=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),e=1/0,r;return t.forEach(n=>{n.actor.wait<e&&(e=n.actor.wait,r=n)}),t.forEach(({actor:n})=>n.wait-=e),r?.entity}commit(t,e){this.world.requireComponent(t,"actor").wait+=e}};var a=new l;await customElements.whenDefined("rl-display");var s=document.querySelector("rl-display");var m=class{get duration(){return 0}canBePerformed(t){}async perform(t){}},p=class extends m{constructor(e){super();this.entity=e}},u=class extends m{constructor(e,r,n){super();this.entity=e;this.x=r;this.y=n}async perform(e){let{entity:r,x:n,y:i}=this,f=e.requireComponent(r,"position");return f.x=n,f.y=i,console.log("moving",r,"to",n,i),s.move(r,n,i)}get duration(){return 10}};Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};var C=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];function g(o,t,e){return e.findEntities("position").filter(r=>r.position.x==o&&r.position.y==t)}function x(o,t,e){return g(o,t,e).every(n=>{let i=e.getComponent(n.entity,"blocks");return i?!i.movement:!0})}async function h(){let{promise:o,resolve:t}=Promise.withResolvers();return window.addEventListener("keydown",t,{once:!0}),o}function v(o,t,e){switch(o.code){case"ArrowLeft":return new u(t,e.x-1,e.y);case"ArrowRight":return new u(t,e.x+1,e.y);case"ArrowUp":return new u(t,e.x,e.y-1);case"ArrowDown":return new u(t,e.x,e.y+1)}}async function T(o,t){let e=t.requireComponent(o,"position");for(;;){let r=await h();return v(r,o,e)}}function b(o,t){let e=t.requireComponent(o,"position"),r=C.filter(i=>x(e.x+i[0],e.y+i[1],t));if(!r.length)return new p(o);let n=r.random();return e.x+=n[0],e.y+=n[1],new u(o,e.x,e.y)}var R={ch:"."};function W(o){switch(a.requireComponent(o,"actor").brain){case"ai":return b(o,a);case"ui":return T(o,a)}}function M(o,t){let e={ch:"#"},r={x:o,y:t},n={sight:!0,movement:!0},i=a.createEntity({position:r,visual:e,blocks:n});return s.draw(o,t,e,{id:i,zIndex:0}),i}function P(o,t){let e={ch:"@"},r={x:o,y:t},n=a.createEntity({position:r,visual:e,actor:{wait:0,brain:"ai",needs:[]}});return s.draw(o,t,e,{id:n,zIndex:1}),n}for(let o=0;o<s.cols;o++)for(let t=0;t<s.rows;t++)o%(s.cols-1)&&t%(s.rows-1)?s.draw(o,t,R):M(o,t);var L=P(5,5),q=new c(a),N=new d(a);for(;;){let o=q.next();if(!o)break;await(await W(o)).perform(a)}
