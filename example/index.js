var u=class{#t=new Map;#e=0;createEntity(t={}){let r=++this.#e;return t&&this.#t.set(r,structuredClone(t)),r}addComponent(t,r,e){let n=this.#t.get(t);n||(n={},this.#t.set(t,n)),n[r]=e}removeComponent(t,...r){let e=this.#t.get(t);r.forEach(n=>delete e[n])}hasComponents(t,...r){let e=this.#t.get(t);return e?m(e,r):!1}findEntities(...t){let r=[];for(let[e,n]of this.#t.entries())m(n,t)&&r.push({entity:e,...n});return r}getComponent(t,r){let e=this.#t.get(t);return e&&e[r]}getComponents(t,...r){return this.#t.get(t)}requireComponent(t,r){let e=this.getComponent(t,r);if(!e)throw new Error;return e}requireComponents(t,...r){let e=this.getComponents(t,...r);if(!e||!m(e,r))throw new Error;return e}};function m(o,t){return t.every(r=>r in o)}var c=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let r=t.find(({actor:e})=>e.wait==0);return r?(r.actor.wait=1,r.entity):(t.forEach(({actor:e})=>e.wait=0),this.next())}},d=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),r=1/0,e;return t.forEach(n=>{n.actor.wait<r&&(r=n.actor.wait,e=n)}),t.forEach(({actor:n})=>n.wait-=r),e?.entity}commit(t,r){this.world.requireComponent(t,"actor").wait+=r}};var i=new u;await customElements.whenDefined("rl-display");var s=document.querySelector("rl-display");var p=class{get duration(){return 0}canBePerformed(t){}async perform(t){}},l=class extends p{constructor(r,e,n){super();this.entity=r;this.x=e;this.y=n}async perform(r){let{entity:e,x:n,y:a}=this,y=r.requireComponent(e,"position");return y.x=n,y.y=a,console.log("moving",e,"to",n,a),s.move(e,n,a)}get duration(){return 10}};function C(o){let t=Math.random()>.5?1:-1,r=Math.random()>.5?1:-1,e=i.requireComponent(o,"position");return e.x+=t,e.y+=r,new l(o,e.x,e.y)}function w(o){let t=Math.random()>.5?1:-1,r=Math.random()>.5?1:-1,e=i.requireComponent(o,"position");return e.x+=t,e.y+=r,new l(o,e.x,e.y)}var E={ch:"."};function T(o){switch(i.requireComponent(o,"actor").brain){case"ai":return w(o);case"ui":return C(o)}}function g(o,t){let r={ch:"#"},e={x:o,y:t},n={sight:!0,movement:!0},a=i.createEntity({position:e,visual:r,blocks:n});return s.draw(o,t,r,{id:a,zIndex:0}),a}function b(o,t){let r={ch:"@"},e={x:o,y:t},n=i.createEntity({position:e,visual:r,actor:{wait:0,brain:"ai"}});return s.draw(o,t,r,{id:n,zIndex:1}),n}for(let o=0;o<s.cols;o++)for(let t=0;t<s.rows;t++)o%(s.cols-1)&&t%(s.rows-1)?s.draw(o,t,E):g(o,t);var D=b(5,5),k=new c(i),K=new d(i);for(;;){let o=k.next();if(!o)break;await(await T(o)).perform(i)}
