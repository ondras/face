var d=class{#t=new Map;#e=0;createEntity(t={}){let e=++this.#e;return t&&this.#t.set(e,structuredClone(t)),e}addComponent(t,e,r){let o=this.#t.get(t);o||(o={},this.#t.set(t,o)),o[e]=r}removeComponent(t,...e){let r=this.#t.get(t);e.forEach(o=>delete r[o])}hasComponents(t,...e){let r=this.#t.get(t);return r?h(r,e):!1}findEntities(...t){let e=[];for(let[r,o]of this.#t.entries())h(o,t)&&e.push({entity:r,...o});return e}getComponent(t,e){let r=this.#t.get(t);return r&&r[e]}getComponents(t,...e){return this.#t.get(t)}requireComponent(t,e){let r=this.getComponent(t,e);if(!r)throw new Error;return r}requireComponents(t,...e){let r=this.getComponents(t,...e);if(!r||!h(r,e))throw new Error;return r}};function h(n,t){return t.every(e=>e in n)}var m=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let e=t.find(({actor:r})=>r.wait==0);return e?(e.actor.wait=1,e.entity):(t.forEach(({actor:r})=>r.wait=0),this.next())}},p=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),e=1/0,r;return t.forEach(o=>{o.actor.wait<e&&(e=o.actor.wait,r=o)}),t.forEach(({actor:o})=>o.wait-=e),r?.entity}commit(t,e){this.world.requireComponent(t,"actor").wait+=e}};var u=new d;await customElements.whenDefined("rl-display");var a=document.querySelector("rl-display");Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};var w=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];function R(n,t,e){return e.findEntities("position").filter(r=>r.position.x==n&&r.position.y==t)}function y(n,t,e){return R(n,t,e).every(o=>{let i=e.getComponent(o.entity,"blocks");return i?!i.movement:!0})}async function g(){let{promise:n,resolve:t}=Promise.withResolvers();return window.addEventListener("keydown",t,{once:!0}),n}function f(n,t,e,r){let o=Math.abs(n-e),i=Math.abs(t-r);return Math.max(o,i)}var c=class{get duration(){return 0}canBePerformed(t){}async perform(t){}},x=class extends c{constructor(e){super();this.entity=e}},l=class extends c{constructor(e,r,o){super();this.entity=e;this.x=r;this.y=o}canBePerformed(e){return y(this.x,this.y,e)}async perform(e){let{entity:r,x:o,y:i}=this,s=e.requireComponent(r,"position");return s.x=o,s.y=i,console.log("moving",r,"to",o,i),a.move(r,o,i)}get duration(){return 10}},b=class extends c{constructor(e,r){super();this.attacker=e;this.target=r}async perform(e){let{attacker:r,target:o}=this;console.log("entity",r,"attacking",o)}};function P(n,t,e){switch(n.code){case"ArrowLeft":return new l(t,e.x-1,e.y);case"ArrowRight":return new l(t,e.x+1,e.y);case"ArrowUp":return new l(t,e.x,e.y-1);case"ArrowDown":return new l(t,e.x,e.y+1)}}async function k(n,t){let e=t.requireComponent(n,"position");for(;;){let r=await g(),o=P(r,n,e);if(o&&o.canBePerformed(t))return o}}function v(n,t){let e=t.requireComponent(n,"position"),r=w.filter(i=>y(e.x+i[0],e.y+i[1],t));if(!r.length)return new x(n);let o=r.random();return e.x+=o[0],e.y+=o[1],new l(n,e.x,e.y)}function q(n,t,e){let r=e.requireComponent(n,"position");return f(r.x,r.y,t.x,t.y)==1}function I(n,t,e){let r=e.requireComponent(n,"position");function o(s,E){let W=f(r.x+s[0],r.y+s[1],t.x,t.y),M=f(r.x+E[0],r.y+E[1],t.x,t.y);return W-M}let i=w.toSorted(o);if(i.length>0){let s=i.shift();return new l(n,r.x+s[0],r.y+s[1])}else return v(n,e)}function A(n,t,e){let{task:r}=t;if(r)switch(r.type){case"attack":let o=e.requireComponent(r.target,"position");return q(n,o,e)?new b(n,r.target):I(n,o,e)}else return v(n,e)}var D={ch:"."};function K(n){let t=u.requireComponent(n,"actor").brain;switch(t.type){case"ai":return A(n,t,u);case"ui":return k(n,u)}}function Q(n,t){let e={ch:"#"},r={x:n,y:t},o={sight:!0,movement:!0},i=u.createEntity({position:r,visual:e,blocks:o});return a.draw(n,t,e,{id:i,zIndex:0}),i}function F(n,t){let e={ch:"@",fg:"red"},r={x:n,y:t},o=u.createEntity({position:r,visual:e,actor:{wait:0,brain:{type:"ui"}}});return a.draw(n,t,e,{id:o,zIndex:1}),o}function z(n,t,e){let r={ch:"o",fg:"lime"},o={x:n,y:t},i={type:"attack",target:e},s=u.createEntity({position:o,visual:r,actor:{wait:0,brain:{type:"ai",task:i}}});return a.draw(n,t,r,{id:s,zIndex:1}),s}for(let n=0;n<a.cols;n++)for(let t=0;t<a.rows;t++)n%(a.cols-1)&&t%(a.rows-1)?a.draw(n,t,D):Q(n,t);var L=F(5,5),Z=z(15,5,L),U=new m(u),$=new p(u);for(;;){let n=U.next();if(!n)break;await(await K(n)).perform(u)}
