var i=class{#t=new Map;#e=0;createEntity(t={}){let e=++this.#e;return t&&this.#t.set(e,structuredClone(t)),e}addComponent(t,e,n){let r=this.#t.get(t);r||(r={},this.#t.set(t,r)),r[e]=n}removeComponent(t,...e){let n=this.#t.get(t);e.forEach(r=>delete n[r])}hasComponents(t,...e){let n=this.#t.get(t);return n?f(n,e):!1}findEntities(...t){let e=[];for(let[n,r]of this.#t.entries())f(r,t)&&e.push({entity:n,...r});return e}queryComponent(t,e){let n=this.#t.get(t);return n&&n[e]}queryComponents(t,...e){return this.#t.get(t)}};function f(o,t){return t.every(e=>e in o)}var s=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let e=t.find(({actor:n})=>n.wait==0);return e?(e.actor.wait=1,e.entity):(t.forEach(({actor:n})=>n.wait=0),this.next())}},l=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),e=1/0,n;return t.forEach(r=>{r.actor.wait<e&&(e=r.actor.wait,n=r)}),t.forEach(({actor:r})=>r.wait-=e),n?.entity}commit(t,e){this.world.queryComponent(t,"actor").wait+=e}};function p(o){return new Promise(t=>setTimeout(t,o))}var d=class{get duration(){return 0}canBePerformed(t){}async perform(t){}},y=class extends d{constructor(e,n,r){super();this.entity=e;this.x=n;this.y=r}async perform(e){let{entity:n,x:r,y:u}=this,c=e.queryComponent(n,"position");if(!c)throw"fixme";c.x=r,c.y=u,console.log("moving",n,"to",r,u),m.move(n,r,u)}get duration(){return 10}};async function C(o){return new y(o,0,0)}var a=new i,m=document.querySelector("rl-display");function w(o,t){let e={ch:"@"},n={x:o,y:t},r=a.createEntity({position:n,visual:e,actor:{wait:0}});return m.draw(o,t,e,{id:r,zIndex:1}),r}var g=w(5,5),h=new s(a),b=new l(a);await customElements.whenDefined("rl-display");for(;;){let o=h.next();if(!o)break;await(await C(o)).perform(a),await p(1e3)}
