var f=class{#t=new Map;#e=0;createEntity(t={}){let e=++this.#e;return t&&this.#t.set(e,structuredClone(t)),e}addComponent(t,e,r){let n=this.#t.get(t);n||(n={},this.#t.set(t,n)),n[e]=r}removeComponent(t,...e){let r=this.#t.get(t);e.forEach(n=>delete r[n])}hasComponents(t,...e){let r=this.#t.get(t);return r?C(r,e):!1}findEntities(...t){let e=[];for(let[r,n]of this.#t.entries())C(n,t)&&e.push({entity:r,...n});return e}getComponent(t,e){let r=this.#t.get(t);return r&&r[e]}getComponents(t,...e){return this.#t.get(t)}requireComponent(t,e){let r=this.getComponent(t,e);if(!r)throw new Error(`entity ${t} is missing the required component ${e}`);return r}requireComponents(t,...e){let r=this.getComponents(t,...e);if(!r||!C(r,e))throw new Error(`entity ${t} is missing the required components ${e}`);return r}};function C(o,t){return t.every(e=>e in o)}var y=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let e=t.find(({actor:r})=>r.wait==0);return e?(e.actor.wait=1,e.entity):(t.forEach(({actor:r})=>r.wait=0),this.next())}},h=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),e=1/0,r;return t.forEach(n=>{n.actor.wait<e&&(e=n.actor.wait,r=n)}),t.forEach(({actor:n})=>n.wait-=e),r?.entity}commit(t,e){this.world.requireComponent(t,"actor").wait+=e}};var u=new f;await customElements.whenDefined("rl-display");var s=document.querySelector("rl-display");Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};var K=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];function E(o){return K.map(([t,e])=>[o.x+t,o.y+e])}function Q(o,t,e){return e.findEntities("position").filter(r=>r.position.x==o&&r.position.y==t)}function m(o,t,e){return Q(o,t,e).every(n=>!e.getComponent(n.entity,"blocks")?.movement)}async function v(){let{promise:o,resolve:t}=Promise.withResolvers();return window.addEventListener("keydown",t,{once:!0}),o}function W(o,t,e,r){let n=Math.abs(o-e),i=Math.abs(t-r);return Math.max(n,i)}var A=2,L=3;function w(o,t,e,r){let n=Math.abs(o-e),i=Math.abs(t-r);return A*Math.max(n,i)+(L-A)*Math.min(n,i)}var l=class{get duration(){return 1}canBePerformed(t){return!0}},b=class extends l{constructor(e){super();this.entity=e}perform(e){}},c=class extends l{constructor(e,r,n){super();this.entity=e;this.x=r;this.y=n}canBePerformed(e){return m(this.x,this.y,e)}async perform(e){let{entity:r,x:n,y:i}=this,a=e.requireComponent(r,"position");return a.x=n,a.y=i,console.log("moving",r,"to",n,i),s.move(r,n,i)}get duration(){return 10}},x=class extends l{constructor(e,r){super();this.attacker=e;this.target=r}async perform(e){let{attacker:r,target:n}=this;if(console.log("entity",r,"attacking",n),Math.random()>.5)return console.log("hit"),new T(r,n);console.log("miss")}},T=class extends l{constructor(e,r){super();this.attacker=e;this.target=r}perform(e){let{attacker:r,target:n}=this,i=e.requireComponent(n,"health");if(i.hp-=1,i.hp<=0)return new k(n)}},k=class extends l{constructor(e){super();this.entity=e}perform(e){}};var P={Numpad1:[-1,1],Numpad2:[0,1],Numpad3:[1,1],Numpad4:[-1,0],Numpad6:[1,0],Numpad7:[-1,-1],Numpad8:[0,-1],Numpad9:[1,-1]},R={ArrowLeft:"Numpad4",ArrowRight:"Numpad6",ArrowUp:"Numpad8",ArrowDown:"Numpad2"};function S(o,t,e){let{code:r}=o;if(r in R&&(r=R[r]),r in P){let n=P[r];return new c(t,e.x+n[0],e.y+n[1])}}async function N(o,t){let e=t.requireComponent(o,"position");for(;;){let r=await v(),n=S(r,o,e);if(n&&n.canBePerformed(t))return n}}function q(o,t){let e=t.requireComponent(o,"position"),r=E(e).filter(i=>m(...i,t));if(!r.length)return new b(o);let n=r.random();return new c(o,...n)}function V(o,t,e){let r=e.requireComponent(o,"position");return W(r.x,r.y,t.x,t.y)==1}function F(o,t,e){let r=e.requireComponent(o,"position"),n=E(r).filter(a=>m(...a,e));function i(a,d){let B=w(...a,t.x,t.y),O=w(...d,t.x,t.y);return B-O}if(n.sort(i),n.length>0){let a=n.shift();return new c(o,...a)}else return q(o,e)}function I(o,t,e){let{task:r}=t;if(r)switch(r.type){case"attack":let n=e.requireComponent(r.target,"position");return V(o,n,e)?new x(o,r.target):F(o,n,e)}else return q(o,e)}var z={ch:"."};function U(o){let t=u.requireComponent(o,"actor").brain;switch(t.type){case"ai":return I(o,t,u);case"ui":return N(o,u)}}function _(o,t){let e={ch:"#"},r={sight:!0,movement:!0},n={x:o,y:t},i=u.createEntity({position:n,visual:e,blocks:r});return s.draw(o,t,e,{id:i,zIndex:0}),i}function j(o,t){let e={ch:"@",fg:"red"},r={movement:!0,sight:!1},n={x:o,y:t},i=u.createEntity({position:n,visual:e,blocks:r,actor:{wait:0,brain:{type:"ui"}},health:{hp:10}});return s.draw(o,t,e,{id:i,zIndex:2}),i}function H(o,t,e){let r={ch:"o",fg:"lime"},n={x:o,y:t},i={movement:!0,sight:!1},a={type:"attack",target:e},d=u.createEntity({position:n,visual:r,blocks:i,actor:{wait:0,brain:{type:"ai",task:a}},health:{hp:1}});return s.draw(o,t,r,{id:d,zIndex:2}),d}for(let o=0;o<s.cols;o++)for(let t=0;t<s.rows;t++)o%(s.cols-1)&&t%(s.rows-1)?s.draw(o,t,z):_(o,t);var G=j(5,5),mt=H(15,5,G),J=new y(u),pt=new h(u),p;for(;;){if(!p){let o=J.next();if(!o)break;p=await U(o)}console.log("got action",p),p=await p.perform(u)||void 0}
