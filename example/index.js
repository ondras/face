var a=class{#t=new Map;#e=0;createEntity(t={}){let e=++this.#e;return t&&this.#t.set(e,structuredClone(t)),e}addComponent(t,e,r){let n=this.#t.get(t);n||(n={},this.#t.set(t,n)),n[e]=r}removeComponent(t,...e){let r=this.#t.get(t);e.forEach(n=>delete r[n])}hasComponents(t,...e){let r=this.#t.get(t);return r?f(r,e):!1}findEntities(...t){let e=[];for(let[r,n]of this.#t.entries())f(n,t)&&e.push({entity:r,...n});return e}queryComponent(t,e){let r=this.#t.get(t);return r&&r[e]}queryComponents(t,...e){return this.#t.get(t)}};function f(o,t){return t.every(e=>e in o)}var u=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let e=t.find(({actor:r})=>r.wait==0);return e?(e.actor.wait=1,e.entity):(t.forEach(({actor:r})=>r.wait=0),this.next())}},d=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),e=1/0,r;return t.forEach(n=>{n.actor.wait<e&&(e=n.actor.wait,r=n)}),t.forEach(({actor:n})=>n.wait-=e),r?.entity}commit(t,e){this.world.queryComponent(t,"actor").wait+=e}};var s=new a;await customElements.whenDefined("rl-display");var i=document.querySelector("rl-display");var m=class{get duration(){return 0}canBePerformed(t){}async perform(t){}},c=class extends m{constructor(e,r,n){super();this.entity=e;this.x=r;this.y=n}async perform(e){let{entity:r,x:n,y:l}=this,y=e.queryComponent(r,"position");if(!y)throw"fixme";return y.x=n,y.y=l,console.log("moving",r,"to",n,l),i.move(r,n,l)}get duration(){return 10}};var C={ch:"."};async function w(o){let t=Math.random()>.5?1:-1,e=Math.random()>.5?1:-1,r=s.queryComponent(o,"position");return r.x+=t,r.y+=e,new c(o,r.x,r.y)}function h(o,t){let e={ch:"#"},r={x:o,y:t},n={sight:!0,movement:!0},l=s.createEntity({position:r,visual:e,blocks:n});return i.draw(o,t,e,{id:l,zIndex:0}),l}function x(o,t){let e={ch:"@"},r={x:o,y:t},n=s.createEntity({position:r,visual:e,actor:{wait:0}});return i.draw(o,t,e,{id:n,zIndex:1}),n}for(let o=0;o<i.cols;o++)for(let t=0;t<i.rows;t++)o%(i.cols-1)&&t%(i.rows-1)?i.draw(o,t,C):h(o,t);var P=x(5,5),E=new u(s),Q=new d(s);for(;;){let o=E.next();if(!o)break;await(await w(o)).perform(s)}
