var m=class{#t=new Map;#e=0;createEntity(t={}){let e=++this.#e;return t&&this.#t.set(e,structuredClone(t)),e}addComponent(t,e,r){let n=this.#t.get(t);n||(n={},this.#t.set(t,n)),n[e]=r}removeComponent(t,...e){let r=this.#t.get(t);e.forEach(n=>delete r[n])}hasComponents(t,...e){let r=this.#t.get(t);return r?h(r,e):!1}findEntities(...t){let e=[];for(let[r,n]of this.#t.entries())h(n,t)&&e.push({entity:r,...n});return e}getComponent(t,e){let r=this.#t.get(t);return r&&r[e]}getComponents(t,...e){return this.#t.get(t)}requireComponent(t,e){let r=this.getComponent(t,e);if(!r)throw new Error;return r}requireComponents(t,...e){let r=this.getComponents(t,...e);if(!r||!h(r,e))throw new Error;return r}};function h(o,t){return t.every(e=>e in o)}var d=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor");if(!t.length)return;let e=t.find(({actor:r})=>r.wait==0);return e?(e.actor.wait=1,e.entity):(t.forEach(({actor:r})=>r.wait=0),this.next())}},p=class{constructor(t){this.world=t}next(){let t=this.world.findEntities("actor"),e=1/0,r;return t.forEach(n=>{n.actor.wait<e&&(e=n.actor.wait,r=n)}),t.forEach(({actor:n})=>n.wait-=e),r?.entity}commit(t,e){this.world.requireComponent(t,"actor").wait+=e}};var u=new m;await customElements.whenDefined("rl-display");var a=document.querySelector("rl-display");Array.prototype.random=function(){return this[Math.floor(Math.random()*this.length)]};var C=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];function N(o,t,e){return e.findEntities("position").filter(r=>r.position.x==o&&r.position.y==t)}function f(o,t,e){return N(o,t,e).every(n=>!n.position.blocks.movement)}async function g(){let{promise:o,resolve:t}=Promise.withResolvers();return window.addEventListener("keydown",t,{once:!0}),o}function y(o,t,e,r){let n=Math.abs(o-e),i=Math.abs(t-r);return Math.max(n,i)}var c=class{get duration(){return 0}canBePerformed(t){}async perform(t){}},x=class extends c{constructor(e){super();this.entity=e}},l=class extends c{constructor(e,r,n){super();this.entity=e;this.x=r;this.y=n}canBePerformed(e){return f(this.x,this.y,e)}async perform(e){let{entity:r,x:n,y:i}=this,s=e.requireComponent(r,"position");return s.x=n,s.y=i,console.log("moving",r,"to",n,i),a.move(r,n,i)}get duration(){return 10}},b=class extends c{constructor(e,r){super();this.attacker=e;this.target=r}async perform(e){let{attacker:r,target:n}=this;console.log("entity",r,"attacking",n)}};var k={Numpad1:[-1,1],Numpad2:[0,1],Numpad3:[1,1],Numpad4:[-1,0],Numpad6:[1,0],Numpad7:[-1,-1],Numpad8:[0,-1],Numpad9:[1,-1]},v={ArrowLeft:"Numpad4",ArrowRight:"Numpad6",ArrowUp:"Numpad8",ArrowDown:"Numpad"};function B(o,t,e){let{code:r}=o;if(r in v&&(r=v[r]),r in k){let n=k[r];return new l(t,e.x+n[0],e.y+n[1])}}async function A(o,t){let e=t.requireComponent(o,"position");for(;;){let r=await g(),n=B(r,o,e);if(n&&n.canBePerformed(t))return n}}function W(o,t){let e=t.requireComponent(o,"position"),r=C.filter(i=>f(e.x+i[0],e.y+i[1],t));if(!r.length)return new x(o);let n=r.random();return e.x+=n[0],e.y+=n[1],new l(o,e.x,e.y)}function I(o,t,e){let r=e.requireComponent(o,"position");return y(r.x,r.y,t.x,t.y)==1}function S(o,t,e){let r=e.requireComponent(o,"position");function n(s,E){let M=y(r.x+s[0],r.y+s[1],t.x,t.y),P=y(r.x+E[0],r.y+E[1],t.x,t.y);return M-P}let i=C.toSorted(n);if(i.length>0){let s=i.shift();return new l(o,r.x+s[0],r.y+s[1])}else return W(o,e)}function R(o,t,e){let{task:r}=t;if(r)switch(r.type){case"attack":let n=e.requireComponent(r.target,"position");return I(o,n,e)?new b(o,r.target):S(o,n,e)}else return W(o,e)}var K={ch:"."};function Q(o){let t=u.requireComponent(o,"actor").brain;switch(t.type){case"ai":return R(o,t,u);case"ui":return A(o,u)}}function F(o,t){let e={ch:"#"},n={x:o,y:t,blocks:{sight:!0,movement:!0}},i=u.createEntity({position:n,visual:e});return a.draw(o,t,e,{id:i,zIndex:0}),i}function z(o,t){let e={ch:"@",fg:"red"},r={x:o,y:t,blocks:{movement:!0,sight:!1}},n=u.createEntity({position:r,visual:e,actor:{wait:0,brain:{type:"ui"}}});return a.draw(o,t,e,{id:n,zIndex:1}),n}function L(o,t,e){let r={ch:"o",fg:"lime"},n={x:o,y:t,blocks:{movement:!0,sight:!1}},i={type:"attack",target:e},s=u.createEntity({position:n,visual:r,actor:{wait:0,brain:{type:"ai",task:i}}});return a.draw(o,t,r,{id:s,zIndex:1}),s}for(let o=0;o<a.cols;o++)for(let t=0;t<a.rows;t++)o%(a.cols-1)&&t%(a.rows-1)?a.draw(o,t,K):F(o,t);var O=z(5,5),tt=L(15,5,O),U=new d(u),et=new p(u);for(;;){let o=U.next();if(!o)break;await(await Q(o)).perform(u)}
